<!DOCTPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Final Project</title>
    <script type="text/javascript" src="d3/d3.js"></script>
    <link rel="stylesheet" type="text/css" href="site.css">
</head>
<body>
    <article>
        <h2>Visualizing Traffic Accidents in NYC</h2>
        <h3>This dataset includes motor vehicle collisions reported to the New York City Police Department (NYPD) 
            from September 2013 to April 2018. 
            Select a period in the timeline to show the devlopment in daily collisions.</h3>
    </article>
    <div id="timelineContainer"></div>
    <div id="chartContainer"></div>
    <p>Data from: <a href="https://data.cityofnewyork.us/Public-Safety/NYPD-Motor-Vehicle-Collisions/h9gi-nx95">
        https://data.cityofnewyork.us/Public-Safety/NYPD-Motor-Vehicle-Collisions/h9gi-nx95</a></p>

    <script type="text/javascript">
        var timelineH = 200;
        var timelineW = 1000;
        var h = timelineH*2;
        var w = 800;
        var padding = 40;
        var paddingR = padding/2;
        var filteredData;
        var xScaleTL, yScaleTL;

        var hoursOfDay = []
        for (var i = 0; i < 24; i++) { hoursOfDay.push(i); }

        // Define variables for path generation.
        var projection = d3.geoMercator().translate([w/2, h/1.65]).scale([50000]).center([-73.955752145,40.648265282]);
        var path = d3.geoPath().projection(projection);

        var color = d3.scaleQuantize().domain([0,4])
								.range(["rgb(147,85,209)","rgb(131,105,224)","rgb(90,82,249)",
                                    "rgb(97,150,249","rgb(66,107,244)"]);

        var timelineSvg = d3.select("#timelineContainer").append("svg").attr("width",timelineW).attr("height",timelineH);
        var chartSvg = d3.select("#chartContainer").append("svg").attr("width",timelineW).attr("height",h);
            
        d3.csv("data/NycOverallCount.csv", function(data) {
            drawTimeline(data);
            drawChart(data);
        });

        // Read traffic-collision-data
        d3.csv("data/NycCollisions2017.csv", function(data) {
            // Old code used for brush.
            /*
            var brushFilterData = function() {
                if (d3.event.selection) {
                    var brushCoordinates = d3.brushSelection(this);
                    filteredData = data.filter(d => isInRange(brushCoordinates, xScaleTL(new Date(d.RPT_DT))));
                }
            }

            var endBrush = function() {
                if (d3.event.selection != null) {
                        //updateBarChart(filteredData);
                } else {
                        // Brush is removed. Show all murders in map and barchart.
                        //updateBarChart(data);
                }
            }

            var updateBarChart = function(dataset) {
                var newDataset = d3.nest().key(function(d) { return d.CMPLNT_FR_TM; })
                        .rollup(function(v) { return v.length; }).entries(dataset);

                // Update domain of y-scale.
                yScaleBars.domain([0, d3.max(newDataset, function(d) { return d.value; })]);

                // Select bars in barchart.
                var bars = chartSvg.selectAll("rect").data(newDataset, function(d) { return d.key; });

                bars.transition().duration(500)
                        .attr("x", function(d) {
                            if (d.key == 0) { return xScaleBars(0); }
                            return xScaleBars(d.key);
                        })
                        .attr("y", function(d) {
                            return yScaleBars(d.value);
                        })
                        .attr("width", xScaleBars.bandwidth())
                        .attr("height", function(d) {
                            return h - yScaleBars(d.value) - padding;
                        })
                        .attr("fill", "steelblue");
            
                yAxisBars = d3.axisLeft(yScaleBars);
                chartSvg.select(".y.axis").transition().duration(500).call(yAxisBars);
            }

            var brush = d3.brushX().extent([[padding,padding],[timelineW-paddingR,timelineH-padding]])
                        .on("brush", brushFilterData).on("end",endBrush);
            
            // Add brush to svg.
            timelineSvg.append("g").attr("id","brush").call(brush);
            */
        });

        var isInRange = function(brushCoordinates, x) {
            var x0 = brushCoordinates[0];
            var x1 = brushCoordinates[1];

            return x0 <= x && x <= x1;
        }

        var drawTimeline = function(data) {
            var barWidth = (timelineW - padding) / data.length - 0.2;

            xScaleTL = d3.scaleTime()
                    .domain([d3.min(data, function(d) { return new Date(d.date); }),
                        d3.max(data, function(d) { return new Date(d.date); })])
                    .range([padding,timelineW - paddingR]);
            
            yScaleTL = d3.scaleLinear().domain([0, d3.max(data, function(d) { return parseInt(d.total); })])
                    .range([timelineH - padding, padding]);

            timelineSvg.selectAll("rect").data(data)
                        .enter()
                        .append("rect")
                        .attr("x", function(d) {
                            return xScaleTL(new Date(d.date)) + 0.1;
                        })
                        .attr("y", function(d) {
                            return yScaleTL(d.total);
                        })
                        .attr("height", function(d) {
                            return timelineH - yScaleTL(d.total) - padding;
                        })
                        .attr("width", barWidth)
                        .attr("fill", "darkgreen");
            
            var xAxisTL = d3.axisBottom(xScaleTL);
            timelineSvg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + (timelineH - padding) + ")")
                    .call(xAxisTL);
            
            var yAxisTL = d3.axisLeft(yScaleTL).ticks(5);
            timelineSvg.append("g")
                    .attr("class", "y axis")
                    .attr("transform", "translate(" + padding + ",0)")
                    .call(yAxisTL);
            
            // Append title to barchart
            timelineSvg.append("text").attr("x", (timelineW / 2)).attr("y", (padding / 2))
                    .attr("text-anchor", "middle").attr("id","title").text("Vehicle collisions in NYC");
                
            // Append x-axis label
            timelineSvg.append("text")
                .attr("class", "x label")
                .attr("text-anchor", "middle")
                .attr("y", timelineH - 20)
                .attr("x", timelineW/2)
                .attr("dy", "1em")
                .attr("font-size", "12px")
                .text("Day");
                
            // Append y-axis label
            timelineSvg.append("text")
                .attr("class", "y label")
                .attr("text-anchor", "middle")
                .attr("y", -1)
                .attr("x", -timelineH/2)
                .attr("dy", "1em")
                .attr("font-size", "12px")
                .attr("transform", "rotate(-90)")
                .text("# of Vehicle Collisions");
        }

        var drawChart = function(data) {
            var xScaleChart = d3.scaleTime()
                    .domain([d3.min(data, function(d) { return new Date(d.date); }),
                        d3.max(data, function(d) { return new Date(d.date); })])
                    .range([padding,timelineW - paddingR]);
            
            var yScaleChart = d3.scaleLinear().domain([0, d3.max(data, function(d) { return parseInt(d.simple); })])
                    .range([h - padding, padding]);

            // Define line showing number of collisions per day with fatalities.
            var fatalLine = d3.line().x(function(d) { return xScaleChart(new Date(d.date)); })
                .y(function(d) { return yScaleChart(d.fatal); });

            // Define line showing number of collisions per day with injuries.
            var seriousLine = d3.line().x(function(d) { return xScaleChart(new Date(d.date)); })
                .y(function(d) { return yScaleChart(d.serious); });
            
            // Define line showing collisions without injuries and fatalities.
            var simpleLine = d3.line().x(function(d) { return xScaleChart(new Date(d.date)); })
                .y(function(d) { return yScaleChart(d.simple); });

            chartSvg.append("path").datum(data).attr("stroke", "red").attr("fill","none").attr("d", fatalLine);
            chartSvg.append("path").datum(data).attr("stroke", "yellow").attr("fill","none").attr("d", seriousLine);
            chartSvg.append("path").datum(data).attr("stroke", "steelblue").attr("fill","none").attr("d", simpleLine);

            // Append x-axis label
            chartSvg.append("text")
                .attr("class", "x label")
                .attr("text-anchor", "middle")
                .attr("y", h - 20)
                .attr("x", timelineW/2)
                .attr("dy", "1em")
                .attr("font-size", "12px")
                .text("Day");
                
            // Append y-axis label
            chartSvg.append("text")
                .attr("class", "y label")
                .attr("text-anchor", "middle")
                .attr("y", -1)
                .attr("x", -h/2)
                .attr("dy", "1em")
                .attr("font-size", "12px")
                .attr("transform", "rotate(-90)")
                .text("# of Vehicle Collisions");

            var xAxis = d3.axisBottom(xScaleChart);
            chartSvg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + (h - padding) + ")")
                .call(xAxis);
            
            var yAxis = d3.axisLeft(yScaleChart);
            chartSvg.append("g")
                .attr("class", "y axis")
                .attr("transform", "translate(" + padding + ",0)")
                .call(yAxis);
        }
    </script>
</body>
</html>