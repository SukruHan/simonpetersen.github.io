<!DOCTPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Week 7</title>
    <script type="text/javascript" src="libs/d3/d3.js"></script>
    <style>
        body {
            text-align: center;
        }

        text {
			font-family: Helvetica, sans-serif;
		}

        article {
            margin: 0 auto;
            width: 70%;
        }

        .label {
				font-size: 11px;
				fill: black;
				text-anchor: middle;
			}
    </style>
</head>
<body>

    <article>
        <h2>This dataset includes reported murders to the New York City Police Department (NYPD). 
            Select a period in the timeline to show the geographical distribution in the map.</h2>
    </article>
    <div id="timelineContainer"></div>
    <div id="mapContainer"></div>
    <p>Data from: <a href="https://data.cityofnewyork.us/Public-Safety/NYPD-Complaint-Data-Historic/qgea-i56i">
        https://data.cityofnewyork.us/Public-Safety/NYPD-Complaint-Data-Historic/qgea-i56i</a></p>

    <script type="text/javascript">
        var h = 400;
        var w = 500;
        var timelineH = h/2;
        var timelineW = w*2;
        var padding = 40;

        // Define variables for path generation.
        var projection = d3.geoMercator().translate([w/2, h/1.65]).scale([32000]).center([-73.955752145,40.648265282]);
        var path = d3.geoPath().projection(projection);

        var color = d3.scaleQuantize().domain([0,4])
								.range(["rgb(147,85,209)","rgb(131,105,224)","rgb(90,82,249)",
                                    "rgb(97,150,249","rgb(66,107,244)"]);

        var mapSvg = d3.select("#mapContainer").append("svg").attr("width",w).attr("height",h);
        var timelineSvg = d3.select("#timelineContainer").append("svg").attr("width",timelineW).attr("height",timelineH);

        var key = function(d) { return d.INDEX;}
        
        d3.json("data/boroughs.json", function(json) {
            // Draw paths in map
            mapSvg.selectAll("path").data(json.features).enter().append("path").attr("d",path)
                .attr("fill", function(d,i) {
                    return color(i);
                });

            // Append label to each borough
            mapSvg.selectAll("text")
						.data(json.features)
						.enter()
						.append("text")
						.attr("class", "label")
						.attr("x", function(d) {
							 return path.centroid(d)[0];
						})
						.attr("y", function(d) {
							 return path.centroid(d)[1];
						})
						.text(function(d) {
                            return d.properties.BoroName;
						});
            
            // Append title to map
            mapSvg.append("text").attr("x", (w / 2)).attr("y", (padding / 2))
                    .attr("text-anchor", "middle").attr("id","title").text("NYC boroughs");
            
            d3.csv("data/all_murder.csv", function(data) {
                mapSvg.selectAll("circle")
                        .data(data, key).enter().append("circle")
                        .attr("cx", function(d) {
                            return projection([d.Longitude, d.Latitude])[0];
                        })
                        .attr("cy", function(d) {
                            return projection([d.Longitude, d.Latitude])[1];
                        })
                        .attr("r", 3)
                        .attr("fill", "lightgrey");
                
                // Count the number of murders per day
                var murdersByDate = d3.nest().key(function(d) { return d.RPT_DT; })
                    .rollup(function(v) { return v.length; }).entries(data);
                
                var xScale = d3.scaleTime()
                    .domain([d3.min(murdersByDate, function(d) { return new Date(d.key); }),
                        d3.max(murdersByDate, function(d) { return new Date(d.key); })])
                    .range([padding,timelineW]);

                var yScale = d3.scaleLinear().domain([0, d3.max(murdersByDate, function(d) { return d.value; })])
                    .range([timelineH - padding, padding]);

                var barWidth = (timelineW - padding) / murdersByDate.length - 0.2;

                // Append title to barchart
                timelineSvg.append("text").attr("x", (timelineW / 2)).attr("y", (padding / 2))
                    .attr("text-anchor", "middle").attr("id","title").text("Murders in NYC");

                timelineSvg.selectAll("rect").data(murdersByDate)
                        .enter()
                        .append("rect")
                        .attr("x", function(d) {
                            return xScale(new Date(d.key)) + 0.1;
                        })
                        .attr("y", function(d) {
                            return yScale(d.value);
                        })
                        .attr("height", function(d) {
                            return timelineH - yScale(d.value) - padding;
                        })
                        .attr("width", barWidth)
                        .attr("fill", "steelblue");
            
                var xAxis = d3.axisBottom(xScale);
                timelineSvg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + (timelineH - padding) + ")")
                    .call(xAxis);
            
                var yAxis = d3.axisLeft(yScale);
                timelineSvg.append("g")
                    .attr("class", "y axis")
                    .attr("transform", "translate(" + padding + ",0)")
                    .call(yAxis);
                
                    // Append x-axis label
                timelineSvg.append("text")
                    .attr("class", "x label")
                    .attr("text-anchor", "middle")
                    .attr("y", timelineH - 20)
                    .attr("x", timelineW/2)
                    .attr("dy", "1em")
                    .attr("font-size", "12px")
                    .text("Day");

                timelineSvg.append("text")
                    .attr("class", "y label")
                    .attr("text-anchor", "middle")
                    .attr("y", -1)
                    .attr("x", -timelineH/2)
                    .attr("dy", "1em")
                    .attr("font-size", "12px")
                    .attr("transform", "rotate(-90)")
                    .text("# of Murders Committed");

                var brushFilterData = function() {
                    if (d3.event.selection) {
                        var brushCoordinates = d3.brushSelection(this);
                        const filteredData = data.filter(d => isInRange(brushCoordinates, xScale(new Date(d.RPT_DT))));
                        updateMap(filteredData);
                    }
                }

                var updateMap = function(dataset) {
                    var circles = mapSvg.selectAll("circle").data(dataset,key);

                    circles.enter()
						.append("circle")
                        .attr("cx", function(d) {
                            return projection([d.Longitude, d.Latitude])[0];
                        })
                        .attr("cy", function(d) {
                            return projection([d.Longitude, d.Latitude])[1];
                        })
                        .attr("r", 3)
                        .attr("fill", "lightgrey")
                        .append("title")
			            .text(function(d) { return d.RPT_DT; })
						.merge(circles);
                    
					circles.exit().remove();
                }

                var brush = d3.brushX().extent([[padding,padding],[timelineW,timelineH-padding]])
                    .on("brush", brushFilterData);
                timelineSvg.append("g").call(brush);
            });
        });

        var isInRange = function(brushCoordinates, x) {
            var x0 = brushCoordinates[0];
            var x1 = brushCoordinates[1];

            return x0 <= x && x <= x1;
        }
    </script>
</body>
</html>