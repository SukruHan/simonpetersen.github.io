<!DOCTPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Week 6</title>
    <script type="text/javascript" src="libs/d3/d3.js"></script>
    <link rel="stylesheet" type="text/css" href="site.css">
</head>
<body>

    <article>
        <h2>This dataset includes reported murders to the New York City Police Department (NYPD) in 2016. 
            Select points in the map to show hourly crime distribution.</h2>
    </article>
    <div id="mapContainer" class="svgContainer"></div>
    <div id="barchartContainer" class="svgContainer"></div>
    <p>Data from: <a href="https://data.cityofnewyork.us/Public-Safety/NYPD-Complaint-Data-Historic/qgea-i56i">
        https://data.cityofnewyork.us/Public-Safety/NYPD-Complaint-Data-Historic/qgea-i56i</a></p>

    <script type="text/javascript">
        var h = 400;
        var w = 500;
        var padding = 40;
        var brushCoordinates;

        // Init array of hour values from 0 - 24
        var hoursOfDay = []
        for (var i = 0; i < 24; i++) { hoursOfDay.push(i); }

        // Define variables for path generation.
        var projection = d3.geoMercator().translate([w/2, h/2+25]).scale([32000]).center([-73.955752145,40.648265282]);
        var path = d3.geoPath().projection(projection);

        var color = d3.scaleQuantize().domain([0,4])
								.range(["rgb(147,85,209)","rgb(131,105,224)","rgb(90,82,249)",
                                    "rgb(97,150,249","rgb(66,107,244)"]);

        var mapSvg = d3.select("#mapContainer").append("svg").attr("width",w).attr("height",h);
        var chartSvg = d3.select("#barchartContainer").append("svg").attr("width",w).attr("height",h);

        var xScale = d3.scaleBand().domain(hoursOfDay).rangeRound([padding,w-padding]).paddingInner(0.05);
        var yScale = d3.scaleLinear().domain([0,20]).range([h - padding, padding]);
        
        d3.json("data/boroughs.json", function(json) {
            mapSvg.selectAll("path").data(json.features).enter().append("path").attr("d",path)
                .attr("fill", function(d,i) {
                    return color(i);
                });
            
            d3.csv("data/Crime-Data.csv", function(data) {
                var circles = mapSvg.selectAll("circle")
                        .data(data).enter().append("circle")
                        .attr("cx", function(d) {
                            return projection([d.Lon, d.Lat])[0];
                        })
                        .attr("cy", function(d) {
                            return projection([d.Lon, d.Lat])[1];
                        })
                        .attr("r", 3)
                        .attr("class", "non_brushed");

                // Append title to map
                mapSvg.append("text").attr("x", (w / 2)).attr("y", (padding / 2))
                    .attr("text-anchor", "middle").attr("id","title").text("NYC boroughs");
                
                var barData = generateBarChartData(data, hoursOfDay);
                yScale.domain([0, d3.max(barData, function(d) { return d.count; })]);

                // Append title to barchart
                chartSvg.append("text").attr("x", (w / 2)).attr("y", (padding / 2))
                    .attr("text-anchor", "middle").attr("id","title").text("Murders in NYC by time of day");

                chartSvg.selectAll("rect").data(barData, function(d) { return d.hour; })
                        .enter()
                        .append("rect")
                        .attr("x", function(d) {
                            return xScale(d.hour);
                        })
                        .attr("y", function(d) {
                            return yScale(d.count);
                        })
                        .attr("height", function(d) {
                            return h - yScale(d.count) - padding;
                        })
                        .attr("width", xScale.bandwidth())
                        .attr("fill", "steelblue");
            
                var xAxis = d3.axisBottom(xScale).tickValues(hoursOfDay);
                chartSvg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + (h - padding) + ")")
                    .call(xAxis);
            
                var yAxis = d3.axisLeft(yScale);
                chartSvg.append("g")
                    .attr("class", "y axis")
                    .attr("transform", "translate(" + padding + ",0)")
                    .call(yAxis);
                
                    // Append x-axis label
                chartSvg.append("text")
                    .attr("class", "x label")
                    .attr("text-anchor", "middle")
                    .attr("y", h - 20)
                    .attr("x", w/2)
                    .attr("dy", "1em")
                    .attr("font-size", "12px")
                    .text("Hours");

                chartSvg.append("text")
                    .attr("class", "y label")
                    .attr("text-anchor", "middle")
                    .attr("y", -1)
                    .attr("x", -h/2)
                    .attr("dy", "1em")
                    .attr("font-size", "12px")
                    .attr("transform", "rotate(-90)")
                    .text("# of Murders Committed");

                // Function for highligting brushed circles.
                var hightlightBrushedCircles = function() {
                    if (d3.event.selection != null) {
                        circles.attr("class", "non_brushed");
                        brushCoordinates = d3.brushSelection(this);

                        // Style brushed circles
                        circles.filter(function() {
                            var cx = d3.select(this).attr("cx"),
                                cy = d3.select(this).attr("cy");

                            return isBrushed(brushCoordinates,cx,cy);
                        }).attr("class","brushed");
                    }
                }

                var updateBarChart = function() {
                    if (brushCoordinates) {
                        var filteredData = filterData();
                        var newBarChartData = generateBarChartData(filteredData, hoursOfDay);

                        // Update domain of y-scale.
                        yScale.domain([0, d3.max(newBarChartData, function(d) { return d.count; })]);

                        var bars = chartSvg.selectAll("rect").data(newBarChartData, function(d) { return d.hour; });

                        bars.transition().duration(500)
                            .attr("x", function(d) {
                                return xScale(d.hour);
                            })
                            .attr("y", function(d) {
                                return yScale(d.count);
                            })
                            .attr("width", xScale.bandwidth())
                            .attr("height", function(d) {
                                return h - yScale(d.count) - padding;
                            })
                            .attr("fill", "steelblue");
            
                        yAxis = d3.axisLeft(yScale);
                        chartSvg.select(".y.axis").transition().duration(500).call(yAxis);
                    }
                }

                var filterData = function() {
                    var filteredDataset = [];

                    for (var i = 0; i < data.length; i++) {
                        var projectedCoords = projection([data[i].Lon, data[i].Lat]);
                        if (isBrushed(brushCoordinates, projectedCoords[0], projectedCoords[1])) {
                            filteredDataset.push(data[i]);
                        }
                    }

                    return filteredDataset;
                }

                var brush = d3.brush().on("brush", hightlightBrushedCircles).on("end", updateBarChart);
                mapSvg.append("g").call(brush);
            });
        });

        var generateBarChartData = function(data, hourValues) {
            var barData = {};
            for (var i = 0; i < hourValues.length; i++) { barData[hourValues[i]] = 0; }

            for (var i = 0; i < data.length; i++) {
                var dataHour = data[i].Hour;
                barData[dataHour]++;
            }

            var barDataArray = []
            for (var i = 0; i < hourValues.length; i++) {
                barDataArray.push({ hour: hourValues[i], count: barData[hourValues[i]] });
            }

            return barDataArray;
        }

        var isBrushed = function(brushCoordinates, cx, cy) {
            var x0 = brushCoordinates[0][0];
            var x1 = brushCoordinates[1][0];
            var y0 = brushCoordinates[0][1];
            var y1 = brushCoordinates[1][1];

            return x0 <= cx && cx <= x1 && y0 <= cy && cy <= y1;
        }
    </script>
</body>
</html>