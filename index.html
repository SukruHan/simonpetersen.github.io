<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Final Project</title>
    <script type="text/javascript" src="d3/d3.js"></script>
    <link rel="stylesheet" type="text/css" href="site.css">
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>

</head>
<body>
    <article>
        <h2>Visualizing Traffic Accidents in NYC</h2>
        <h3>This dataset includes motor vehicle collisions reported to the New York City Police Department (NYPD) 
            from September 2013 to April 2018. 
            Select a period in the timeline to show the devlopment in daily collisions.</h3>
    </article>
    <div id="timelineContainer"></div>
    <div id="chartContainer"></div>
    <div>
        <span>
            <input type="radio" name="yearlyradio" value="hourly" onclick='change(this.value)' checked>Collisions per hour
            <input type="radio" name="yearlyradio" value="type" onclick='change(this.value)'>Types of collisions
            <input type="radio" name="yearlyradio" value="borough" onclick='change(this.value)'>Boroughs
        </span>
    </div>
    <span>
        <div id="yearlyOverview">
        </div>
        <div id="tooltip" class="hidden">
            <p><strong>Amount Accidents without Injuries: </strong><span id='non-value'>0</span></p>
            <p><strong>Amount Accidents with Injuries: </strong><span id='serious-value'>0</span></p>
            <p><strong>Amount Accidents with Fatalities: </strong><span id='fatal-value'>0</span></p>
        </div>
        <div id="taxiRadios">
            <input type="radio" name="taxi" value="all" onclick='change(this.value)' checked> All
            <input type="radio" name="taxi" value="taxi" onclick='change(this.value)'> Taxi
            <input type="radio" name="taxi" value="bike" onclick='change(this.value)'> Cyclists/Pedestrians
        </div>
    </span>
    <p>Data from: <a href="https://data.cityofnewyork.us/Public-Safety/NYPD-Motor-Vehicle-Collisions/h9gi-nx95">
        https://data.cityofnewyork.us/Public-Safety/NYPD-Motor-Vehicle-Collisions/h9gi-nx95</a></p>

    <script type="text/javascript">
        var timelineH = 200;
        var timelineW = 1000;
        var h = timelineH*2;
        var w = 800;
        var padding = 40;
        var paddingR = padding/2;
        var filteredData;
        var xScaleTL, yScaleTL;

        var hoursOfDay = []
        for (var i = 0; i < 24; i++) { hoursOfDay.push(i); }

        // Define variables for path generation.
        var projection = d3.geoMercator().translate([w/2, h/1.65]).scale([50000]).center([-73.955752145,40.648265282]);
        var path = d3.geoPath().projection(projection);

        var color = d3.scaleQuantize().domain([0,4])
								.range(["rgb(147,85,209)","rgb(131,105,224)","rgb(90,82,249)",
                                    "rgb(97,150,249","rgb(66,107,244)"]);

        var timelineSvg = d3.select("#timelineContainer").append("svg").attr("width",timelineW).attr("height",timelineH);
        var chartSvg = d3.select("#chartContainer").append("svg").attr("width",timelineW).attr("height",h);
        var barSvg = d3.select("#yearlyOverview").append("svg").attr("width", timelineW).attr("height", h);
            
        d3.csv("data/NycOverallCount.csv", function(data) {
            drawTimeline(data);
            drawChart(data);
        });

        d3.csv("data/NycVehicleCollisions2017_geo.csv", function(data){
            drawBarChart2017(data);
        });

        var key = function(d) { return d.INDEX;}

        var isInRange = function(brushCoordinates, x) {
            var x0 = brushCoordinates[0];
            var x1 = brushCoordinates[1];

            return x0 <= x && x <= x1;
        }

        var drawTimeline = function(data) {
            var barWidth = (timelineW - padding) / data.length - 0.2;

            xScaleTL = d3.scaleTime()
                    .domain([d3.min(data, function(d) { return new Date(d.date); }),
                        d3.max(data, function(d) { return new Date(d.date); })])
                    .range([padding,timelineW - paddingR]);
            
            yScaleTL = d3.scaleLinear().domain([0, d3.max(data, function(d) { return parseInt(d.total); })])
                    .range([timelineH - padding, padding]);

            timelineSvg.selectAll("rect").data(data)
                        .enter()
                        .append("rect")
                        .attr("x", function(d) {
                            return xScaleTL(new Date(d.date)) + 0.1;
                        })
                        .attr("y", function(d) {
                            return yScaleTL(d.total);
                        })
                        .attr("height", function(d) {
                            return timelineH - yScaleTL(d.total) - padding;
                        })
                        .attr("width", barWidth)
                        .attr("fill", "darkgreen");
            
            var xAxisTL = d3.axisBottom(xScaleTL);
            timelineSvg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + (timelineH - padding) + ")")
                    .call(xAxisTL);
            
            var yAxisTL = d3.axisLeft(yScaleTL).ticks(5);
            timelineSvg.append("g")
                    .attr("class", "y axis")
                    .attr("transform", "translate(" + padding + ",0)")
                    .call(yAxisTL);
            
            // Append title to barchart
            timelineSvg.append("text").attr("x", (timelineW / 2)).attr("y", (padding / 2))
                    .attr("text-anchor", "middle").attr("id","title").text("Vehicle collisions in NYC");
                
            // Append x-axis label
            timelineSvg.append("text")
                .attr("class", "x label")
                .attr("text-anchor", "middle")
                .attr("y", timelineH - 20)
                .attr("x", timelineW/2)
                .attr("dy", "1em")
                .attr("font-size", "12px")
                .text("Day");
                
            // Append y-axis label
            timelineSvg.append("text")
                .attr("class", "y label")
                .attr("text-anchor", "middle")
                .attr("y", -1)
                .attr("x", -timelineH/2)
                .attr("dy", "1em")
                .attr("font-size", "12px")
                .attr("transform", "rotate(-90)")
                .text("# of Vehicle Collisions");
        }

        var drawChart = function(data) {
            var xScaleChart = d3.scaleTime()
                    .domain([d3.min(data, function(d) { return new Date(d.date); }),
                        d3.max(data, function(d) { return new Date(d.date); })])
                    .range([padding,timelineW - paddingR]);
            
            var yScaleChart = d3.scaleLinear().domain([0, d3.max(data, function(d) { return parseInt(d.simple); })])
                    .range([h - padding, padding]);

            // Define line showing number of collisions per day with fatalities.
            var fatalLine = d3.line().x(function(d) { return xScaleChart(new Date(d.date)); })
                .y(function(d) { return yScaleChart(d.fatal); });

            // Define line showing number of collisions per day with injuries.
            var seriousLine = d3.line().x(function(d) { return xScaleChart(new Date(d.date)); })
                .y(function(d) { return yScaleChart(d.serious); });
            
            // Define line showing collisions without injuries and fatalities.
            var simpleLine = d3.line().x(function(d) { return xScaleChart(new Date(d.date)); })
                .y(function(d) { return yScaleChart(d.simple); });

            chartSvg.append("path").datum(data).attr("stroke", "red").attr("fill","none").attr("d", fatalLine);
            chartSvg.append("path").datum(data).attr("stroke", "yellow").attr("fill","none").attr("d", seriousLine);
            chartSvg.append("path").datum(data).attr("stroke", "steelblue").attr("fill","none").attr("d", simpleLine);

            // Append x-axis label
            chartSvg.append("text")
                .attr("class", "x label")
                .attr("text-anchor", "middle")
                .attr("y", h - 20)
                .attr("x", timelineW/2)
                .attr("dy", "1em")
                .attr("font-size", "12px")
                .text("Day");
                
            // Append y-axis label
            chartSvg.append("text")
                .attr("class", "y label")
                .attr("text-anchor", "middle")
                .attr("y", -1)
                .attr("x", -h/2)
                .attr("dy", "1em")
                .attr("font-size", "12px")
                .attr("transform", "rotate(-90)")
                .text("# of Vehicle Collisions");

            var xAxis = d3.axisBottom(xScaleChart);
            chartSvg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + (h - padding) + ")")
                .call(xAxis);
            
            var yAxis = d3.axisLeft(yScaleChart);
            chartSvg.append("g")
                .attr("class", "y axis")
                .attr("transform", "translate(" + padding + ",0)")
                .call(yAxis);
        }

        //Third Chart
        //variables for yearlyOverview chart
        var degreeSeries, DegreesByHourType, taxiType, bikeType, neighborhoodType, typeOfAccidentType;
        var sumValues;
        var xScaleYear, yScaleYear, xAxisYear, yAxisYear;
        var stack, groups, colors;
        
        //Initial chart setup
        var drawBarChart2017 = function(data) {
            //seriousness degrees of crashes per hour
            var crashDegreesByHour = d3.nest().key(function(d) { return d.hour; }).sortKeys(function(a, b) { return a - b;})
                .key(function(d) { return d.seriousDegree; }).sortKeys(function(d) { return })
                .rollup(function(v) { return v.length; }).entries(data);
            
            //data for type of accident taxi and bike.
            var AccidentTaxi = d3.nest().key(function(d) { return d.hour; }).sortKeys(function(a, b) { return a - b;})
                .key(function(d) { return d.seriousDegree; }).sortKeys(function(d) { return })
                .key(function(d) { return d.taxi; }).sortKeys(function(d) { return })
                .rollup(function(v) { return v.length; }).entries(data);

            var AccidentCyclist = d3.nest().key(function(d) { return d.hour; }).sortKeys(function(a, b) { return a - b;})
                .key(function(d) { return d.seriousDegree; }).sortKeys(function(d) { return })
                .key(function(d) { return d.pedestrianCyclist }).sortKeys(function(d) { return })
                .rollup(function(v) { return v.length; }).entries(data);

            //data for borough
            var neighborhood = d3.nest().key(function(d) { return d.borough.toLowerCase(); }).sortKeys(d3.ascending)
                .key(function(d) { return d.seriousDegree; }).sortKeys(function(d) { return })
                .rollup(function(v) { return v.length; }).entries(data);

            var typeOfAccident = d3.nest().key(function(d) { return d.vehicles; }).sortKeys(function(a, b) { return a - b;})
                .key(function(d) { return d.seriousDegree; }).sortKeys(function(d) { return })
                .rollup(function(v) { return v.length; }).entries(data);

            //Make dataset stackable
            stack = d3.stack()
                            .keys(["One", "Two", "Three"]);

            DegreesByHourType = transformDictionary(crashDegreesByHour);
            degreeSeries = stack(DegreesByHourType);
            taxiType = transformDictionaryTaxi(AccidentTaxi);
            bikeType = transformDictionaryTaxi(AccidentCyclist);
            neighborhoodType = transformDictionaryBorough(neighborhood);
            typeOfAccidentType = transformDictionaryType(typeOfAccident);


            //coloring [blue, yellow, red]
            colors = ["rgb(20, 74, 122)", "rgb(244, 185, 66)", "rgb(135, 50, 40)"];
            var z = d3.scaleOrdinal().range(colors);

            //Adding a group for each row
            groups = barSvg.selectAll("g")
				.data(degreeSeries)
				.enter()
				.append("g")
				.style("fill", z);

            updateTime(DegreesByHourType);

            xAxisYear = d3.axisBottom(xScaleYear);
            barSvg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0, " + (h - padding) + ")")
                    .call(xAxisYear);

            yAxisYear = d3.axisLeft(yScaleYear);
            barSvg.append("g")
                    .attr("class", "y axis")
                    .attr("transform", "translate(" + (padding + 15) + ", 0)")
                    .call(yAxisYear);


            // Append title to barchart
            barSvg.append("text").attr("x", (timelineW / 2)).attr("y", (padding / 2))
                    .attr("text-anchor", "middle").attr("id","title").text("Mean of Vehicle collisions in NYC per hour");
                
            // Append x-axis label
            barSvg.append("text")
                .attr("class", "x label")
                .attr("text-anchor", "middle")
                .attr("y", h - 20)
                .attr("x", timelineW/2)
                .attr("dy", "1em")
                .attr("font-size", "12px")
                .text("Time of Day");
                
            // Append y-axis label
            barSvg.append("text")
                .attr("class", "y label")
                .attr("text-anchor", "middle")
                .attr("y", -1)
                .attr("x", -h/2)
                .attr("dy", "1em")
                .attr("font-size", "12px")
                .attr("transform", "rotate(-90)")
                .text("# of Vehicle Collisions");

            var legend = groups.append('g')
                .attr('font-size', 10)
                .attr('text-anchor', 'end');

            var legendEnter = legend.selectAll('g')
                .data(["Accidents without Injuries", "Accidents with Injuries", "Accidents with Fatalities"])
                .enter().append('g')
                .attr('transform', function(d, i) { return 'translate(0,' + i * 20 + ')'; });

            legendEnter.append('circle')
                .attr('cx', timelineW - 19)
                .attr('cy', 9)
                .attr('r', 5)
                .attr('fill', z);

            legendEnter.append('text')
                .attr('x', timelineW - 26)
                .attr('y', 9.5)
                .attr('fill', 'black')
                .attr('dy', '0.32em')
                .text(d => d);

        };

        //function for transforming nest dictionary for hour of day
        var transformDictionary = function(data) {
            var array = [];
            for (var hour in data) {
                var obj = {hour: hour, 
                    One: data[hour].values[0].value, 
                    Two: data[hour].values[1].value, 
                    Three: data[hour].values[2].value};
                array.push(obj);
            }

            return array;
        }
        
        //function for transforming nest dictionary for taxi/cyclist
        var transformDictionaryTaxi = function(data) {
            var array = [];
            for (var hour in data) {
                var one = 0,  two = 0, three = 0;
                if(data[hour].values[0].values[1] != null)
                    one = data[hour].values[0].values[1].value;
                if(data[hour].values[1].values[1] != null)
                    two = data[hour].values[1].values[1].value;
                if(data[hour].values[2].values[1] != null)
                    three = data[hour].values[2].values[1].value;

                var obj = {hour:hour,
                One: one,
                Two: two, 
                Three: three
                };
                array.push(obj);
            }
            return array;
        }

        //function for transforming nest dictionary for type-of-accident
        var transformDictionaryType = function(data) {
            var array = []; 
            for (var key in data) {
                var nkey = data[key].key;
                if(nkey == '0')
                    nkey = '1';
                var obj = {
                    key: nkey,
                    One: data[key].values[0].value, 
                    Two: data[key].values[1].value, 
                    Three: data[key].values[2].value
                    };
                array.push(obj);
            }
            return array;
        }

        //function for transforming nest dictionary for borough
        var transformDictionaryBorough = function(data) {
            var array = [];
            var unknown = 0; 
            for (var key in data) {
                if(data[key].key === "") unknown = data[key];
                else if(data[key].key === "unknown"){
                    var obj = {
                        key: key,
                        One: data[key].values[0].value + unknown.values[0].value,
                        Two: data[key].values[1].value + unknown.values[1].value,
                        Three: data[key].values[2].value + unknown.values[2].value
                    };
                    array.push(obj);
                }    
                else{
                    var obj = {
                        key: key,
                        One: data[key].values[0].value,
                        Two: data[key].values[1].value,
                        Three: data[key].values[2].value
                    }
                    array.push(obj);
                }

            }
            return array;
        }
        
        //OnClick function for radiobuttons
        function change(value){
            if(value === 'hourly'){
                updateTime(DegreesByHourType);
                d3.select("#taxiRadios").style("display", "inline");
            }
            else if(value === 'type'){
                updateBorough(typeOfAccidentType,false);
                d3.select("#taxiRadios").style("display", "none");
            }
            else if(value === 'borough'){
                updateBorough(neighborhoodType,true);
                d3.select("#taxiRadios").style("display", "none");
            }
            else if(value === 'all'){
                updateTime(DegreesByHourType);
            }
            else if(value === 'taxi'){
                updateTime(taxiType);
            }
            else if(value === 'bike'){
                updateTime(bikeType);
            }
        }

        //Function for updating hour-of-day chart
        function updateTime(data){
            //clear svg
            var selection = barSvg.selectAll('g')
                .data(data);

            groups.selectAll("rect")
                    .merge(selection)
                    .remove()
                    .exit();

            sumValues = function(d) {
                return d.One + d.Two + d.Three;
            }

            groups.data(stack(data));
            
            xScaleYear = d3.scaleBand()
                    .domain(d3.range(24))
                    .rangeRound([0,timelineW])
                    .paddingInner(0.05)
                    .range([padding + 15, timelineW - paddingR]);

            yScaleYear = d3.scaleLinear()
                .domain([0, d3.max(data, sumValues)])
                    .range([h - padding, padding]);

            var enterBars = groups.selectAll("rect")
                .data(function (d) {return d; })
                .enter()
                .append("rect")
                .attr('y', h - padding)
                .attr('x', (d,i) => { return xScaleYear(i);});

            enterBars
                .merge(groups)
                .transition()
                .delay((d,i) => i * 50)
                .attr("x", function(d, i) { return xScaleYear(i); })
                .attr("y", function(d) { return yScaleYear(d[1]); })
                .attr("height", function(d) { return yScaleYear(d[0]) - yScaleYear(d[1]); })
                .attr("width", xScaleYear.bandwidth());

            enterBars
                .on("mouseover", function(d) {
                    var xPosition = parseFloat(d3.select(this).attr("x")) + xScaleYear.bandwidth() / 2 + 90;
                    var yPosition = parseFloat(d3.select(this).attr("y"));

                    d3.select("#tooltip")
                        .style("left", (xPosition + document.getElementById("yearlyOverview").offsetLeft) + "px")
                        .style("top", (yPosition + document.getElementById("yearlyOverview").offsetTop) + "px")						
                        .transition()
                        .duration(500)
                        .style("opacity", 0.9)
                        .select("#non-value")
                        .text(d.data.One)
                    d3.select("#tooltip")
                        .select("#serious-value")
                        .text(d.data.Two)
                    d3.select("#tooltip")
                        .select("#fatal-value")
                        .text(d.data.Three);

                    d3.select("#tooltip").classed("hidden", false);
                    })
                    .on("mouseout", function() {
                    d3.select("#tooltip")
                        .transition()
                        .duration(200)
                        .style("opacity", 0);

                    });
            
            yAxisYear = d3.axisLeft(yScaleYear);
            barSvg.select(".y.axis").transition().duration(500).call(yAxisYear);

            xAxisYear = d3.axisBottom(xScaleYear);
            barSvg.select(".x.axis").transition().duration(500).call(xAxisYear);

            barSvg.select("#title").transition().duration(500).text("Vehicle Collisions in NYC Shown Per Hour");
            barSvg.select(".x.label").transition().duration(500).text("Time of Day");
            barSvg.select(".y.label").transition().duration(500).text("# of Vehicle Collisions");
        }

        //Function for updating Boroughs and Type-of-Accident
        function updateBorough(data, isborough){
            var boroughs = ['Bronx', 'Brooklyn', 'Manhatten', 'Queens', 'Staten Island', 'Unknown'];
            barSvg.select("#title").transition().duration(500).text("Vehicle Collisions in NYC Shown Per Borough");
            barSvg.select(".x.label").transition().duration(500).text("Borough");
            barSvg.select(".y.label").transition().duration(500).text("# of Vehicle Collisions");
            if(!isborough){
                boroughs = ['Solo Accident', 'Two Cars', 'Three Cars', 'Four Cars', 'Five Cars', 'Six Cars'];
                barSvg.select("#title").transition().duration(500).text("Vehicle Collisions in NYC Shown for Type of Accident");
                barSvg.select(".x.label").transition().duration(500).text("Number of Vehicles involved");
                barSvg.select(".y.label").transition().duration(500).text("# of Vehicle Collisions");
            }

            barSvg.selectAll("rect")
                .remove()
                .exit()
                .data(data);

            var newdata = stack(data);

            sumValues = function(d) {
                return d.One + d.Two + d.Three;
            }

            xScaleYear = d3.scaleBand()
                    .domain(boroughs)
                    .rangeRound([0,timelineW])
                    .paddingInner(0.05)
                    .range([padding + 15, timelineW - paddingR]);

            yScaleYear = d3.scaleLinear()
                    .domain([0, d3.max(data, sumValues) ])
                    .range([h - padding, padding]);

            groups.data(newdata);

            var enterBars = groups.selectAll("rect")
                .data(function (d) {return d; })
                .enter()
                .append("rect")
                .attr('y', h-padding)
                .attr('x', (d,i) => { return xScaleYear(boroughs[i]); });
            
            enterBars
                .merge(groups)
                .transition()
                .delay((d,i) => i * 50)
                .attr("x", function(d, i) { return xScaleYear(boroughs[i]); })
                .attr("y", function(d) { return yScaleYear(d[1]); })
                .attr("height", function(d) { return yScaleYear(d[0]) - yScaleYear(d[1]); })
                .attr("width", xScaleYear.bandwidth());

            enterBars
                .on("mouseover", function(d) {
                    var xPosition = parseFloat(d3.select(this).attr("x")) + xScaleYear.bandwidth() / 2 + 100;
                    var yPosition = parseFloat(d3.select(this).attr("y"));

                    d3.select("#tooltip")
                        .style("left", (xPosition + document.getElementById("yearlyOverview").offsetLeft) + "px")
                        .style("top", (yPosition + document.getElementById("yearlyOverview").offsetTop) + "px")						
                        .transition()
                        .duration(500)
                        .style("opacity", 0.9)
                        .select("#non-value")
                        .text(d.data.One)
                    d3.select("#tooltip")
                        .select("#serious-value")
                        .text(d.data.Two)
                    d3.select("#tooltip")
                        .select("#fatal-value")
                        .text(d.data.Three);

                    d3.select("#tooltip").classed("hidden", false);
                    })
                .on("mouseout", function() {
                d3.select("#tooltip")
                    .transition()
                    .duration(200)
                    .style("opacity", 0);

                });

            yAxisYear = d3.axisLeft(yScaleYear);
            barSvg.select(".y.axis").transition().duration(500).call(yAxisYear);

            xAxisYear = d3.axisBottom(xScaleYear);
            barSvg.select(".x.axis").transition().duration(500).call(xAxisYear);
            

        }
    </script>
</body>
</html>